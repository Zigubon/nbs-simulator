<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>ZIGUBON Forest Simulator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.css">
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.js"></script>
  <script>
    stlite.mount({
      requirements: ["streamlit", "pandas", "numpy", "plotly", "scipy"],
      entrypoint: "app_v2.py",
      files: {
        "app_v2.py": `
import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go

# -----------------------------------------------------------
# 1. í™˜ê²½ ì„¤ì •
# -----------------------------------------------------------
st.set_page_config(page_title="ZIGUBON Simulator", page_icon="ğŸŒ²", layout="wide")

# ìŠ¤íƒ€ì¼ ì ìš©
st.markdown("""
    <style>
    .main { background-color: #f4f6f9; }
    div[data-testid="stMetricValue"] { font-size: 24px; color: #2c3e50; }
    </style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (ì§€êµ¬ë³¸ ê¹ƒí—ˆë¸Œ ì£¼ì†Œ ìë™ ì—°ê²°)
# -----------------------------------------------------------
@st.cache_data
def load_data():
    # ì§€êµ¬ë³¸ë‹˜ì˜ ê¹ƒí—ˆë¸Œì— ìˆëŠ” CSV íŒŒì¼ ì£¼ì†Œì…ë‹ˆë‹¤.
    base_url = "https://raw.githubusercontent.com/zigubon/nbs-simulator/main/"
    
    try:
        # íŒŒì¼ 3ê°œë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.
        forest = pd.read_csv(base_url + "forest_data_2026.csv")
        price = pd.read_csv(base_url + "carbon_price_scenarios.csv")
        benefit = pd.read_csv(base_url + "co_benefits.csv")
        return forest, price, benefit
    except:
        # í˜¹ì‹œ main ë¸Œëœì¹˜ê°€ ì•„ë‹ˆë¼ master ë¸Œëœì¹˜ì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì˜ˆë¹„ ì£¼ì†Œë¡œ ì‹œë„
        base_url = "https://raw.githubusercontent.com/zigubon/nbs-simulator/master/"
        forest = pd.read_csv(base_url + "forest_data_2026.csv")
        price = pd.read_csv(base_url + "carbon_price_scenarios.csv")
        benefit = pd.read_csv(base_url + "co_benefits.csv")
        return forest, price, benefit

try:
    df_forest, df_price, df_benefit = load_data()
except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨! CSV íŒŒì¼ì´ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\\nì—ëŸ¬ ë‚´ìš©: {e}")
    st.stop()

# -----------------------------------------------------------
# 3. ë©”ì¸ í™”ë©´ ë° ì‹œë®¬ë ˆì´ì…˜
# -----------------------------------------------------------
st.title("ğŸŒ² ì‚°ë¦¼íƒ„ì†Œìƒì‡„ ì‹œë®¬ë ˆì´í„°")
st.caption("Powered by ZIGUBON (Serverless Mode)")

# ì‚¬ì´ë“œë°”: ì…ë ¥ ë°›ê¸°
with st.sidebar:
    st.header("âš™ï¸ ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •")
    area = st.number_input("ì‚¬ì—… ë©´ì  (ha)", min_value=1, value=10)
    project_period = st.slider("ì‚¬ì—… ê¸°ê°„ (ë…„)", 10, 50, 30)
    
    st.subheader("ìˆ˜ì¢… ì„ íƒ")
    species_list = df_forest['name'].unique()
    selected_species = st.multiselect("ì‹ì¬ ìˆ˜ì¢… (í˜¼íš¨ë¦¼)", species_list, default=[species_list[0]])
    
    if not selected_species:
        st.warning("ìˆ˜ì¢…ì„ ìµœì†Œ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.")
        st.stop()

# ê³„ì‚° ë¡œì§
years = list(range(2026, 2026 + project_period + 1))
chart_data = []
total_last_uptake = 0

for sp in selected_species:
    # í•´ë‹¹ ìˆ˜ì¢…ì˜ 50ë…„ì¹˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
    sp_row = df_forest[df_forest['name'] == sp].iloc[0]
    
    # ë°ì´í„°ì— ìˆëŠ” ì—°ë„ ì»¬ëŸ¼ë§Œ ê°€ì ¸ì˜¤ê¸° (co2_yr_0 ~ co2_yr_50)
    y_vals = []
    for yr in range(0, 51, 5): # 0, 5, 10 ... 50
        y_vals.append(sp_row[f'co2_yr_{yr}'])
    
    # ì„ í˜• ë³´ê°„ (5ë…„ ë‹¨ìœ„ ë°ì´í„°ë¥¼ 1ë…„ ë‹¨ìœ„ë¡œ ë¶€ë“œëŸ½ê²Œ ë§Œë“¤ê¸°)
    x_points = list(range(0, 51, 5))
    full_uptake = np.interp(range(project_period + 1), x_points, y_vals)
    
    # ë©´ì  ë° ìˆ˜ì¢… ë¹„ìœ¨ ì ìš© (Në¹µ)
    ratio_area = area / len(selected_species)
    final_uptake = full_uptake * ratio_area
    
    total_last_uptake += final_uptake[-1]
    
    chart_data.append(go.Scatter(x=years, y=final_uptake, name=sp, stackgroup='one'))

# ì°¨íŠ¸ ê·¸ë¦¬ê¸°
fig = go.Figure(data=chart_data)
fig.update_layout(
    title="ì—°ë„ë³„ ì˜ˆìƒ íƒ„ì†Œ í¡ìˆ˜ëŸ‰ (ëˆ„ì )", 
    xaxis_title="ì—°ë„", 
    yaxis_title="ëˆ„ì  í¡ìˆ˜ëŸ‰ (tCO2)",
    height=400
)
st.plotly_chart(fig, use_container_width=True)

# í•˜ë‹¨ KPI ì¹´ë“œ
c1, c2, c3 = st.columns(3)
c1.metric("ì´ ì˜ˆìƒ í¡ìˆ˜ëŸ‰", f"{total_last_uptake:,.1f} tCOâ‚‚")
c2.metric("ì˜ˆìƒ ê°€ì¹˜ (í˜„ì¬ê°€)", f"â‚©{total_last_uptake * 15000:,.0f}")
c3.metric("í‰ê·  ESG ì ìˆ˜", f"{df_benefit[df_benefit['id'].isin(df_forest[df_forest['name'].isin(selected_species)]['id'])]['biodiversity_index'].mean():.1f} / 5.0")

`
      }
    })
  </script>
</body>
</html>
