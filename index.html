<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>ZIGUBON Forest Simulator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.css">
</head>
<body>
  <div id="root"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.js"></script>
  
  <script>
    stlite.mount({
      requirements: ["streamlit", "pandas", "numpy", "plotly", "scipy"],
      entrypoint: "app_v2.py",
      files: {
        /* [í•µì‹¬] íŒŒì´ì¬ ì½”ë“œ (app_v2.py)
           - ê°™ì€ í´ë”ì— ìˆëŠ” CSV íŒŒì¼ì„ ì½ì–´ì„œ ì‹œë®¬ë ˆì´ì…˜ì„ ëŒë¦½ë‹ˆë‹¤.
        */
        "app_v2.py": `
import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from scipy.interpolate import interp1d

# -----------------------------------------------------------
# 1. í™˜ê²½ ì„¤ì •
# -----------------------------------------------------------
st.set_page_config(page_title="ZIGUBON Simulator", page_icon="ğŸŒ²", layout="wide")

st.markdown("""
    <style>
    .main { background-color: #f4f6f9; }
    div[data-testid="stMetricValue"] { font-size: 24px; color: #2c3e50; }
    </style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (ê°™ì€ í´ë”ì— ìˆëŠ” CSV ì½ê¸°)
# -----------------------------------------------------------
@st.cache_data
def load_data():
    # 'http_open'ì„ ì‚¬ìš©í•˜ì—¬ ì›¹ í™˜ê²½ì—ì„œ ê°™ì€ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ì–´ì˜µë‹ˆë‹¤.
    # ë¡œì»¬/ì„œë²„ í™˜ê²½ ì°¨ì´ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•œ stlite ì „ìš© ë°©ì‹ ê¶Œì¥
    try:
        # GitHub Pagesì—ì„œëŠ” ìƒëŒ€ ê²½ë¡œ("./") ì¸ì‹ì´ ì˜ ë©ë‹ˆë‹¤.
        forest = pd.read_csv("./forest_data_2026.csv")
        price = pd.read_csv("./carbon_price_scenarios.csv")
        benefit = pd.read_csv("./co_benefits.csv")
        return forest, price, benefit
    except Exception as e:
        # í˜¹ì‹œë¼ë„ ì‹¤íŒ¨í•˜ë©´ fetch ë°©ì‹ìœ¼ë¡œ ì‹œë„ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±)
        import pyodide.http
        forest_url = "./forest_data_2026.csv"
        price_url = "./carbon_price_scenarios.csv"
        benefit_url = "./co_benefits.csv"
        
        forest = pd.read_csv(pyodide.http.open_url(forest_url))
        price = pd.read_csv(pyodide.http.open_url(price_url))
        benefit = pd.read_csv(pyodide.http.open_url(benefit_url))
        return forest, price, benefit

try:
    df_forest, df_price, df_benefit = load_data()
except Exception as e:
    st.error(f"âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. CSV íŒŒì¼ë“¤ì´ index.htmlê³¼ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\\nì—ëŸ¬: {e}")
    st.stop()

# -----------------------------------------------------------
# 3. UI ë° ì‹œë®¬ë ˆì´ì…˜ ë¡œì§
# -----------------------------------------------------------
st.title("ğŸŒ² ì‚°ë¦¼íƒ„ì†Œìƒì‡„ ì‹œë®¬ë ˆì´í„°")
st.caption("Powered by ZIGUBON (Web Assembly Ver.)")

# ì‚¬ì´ë“œë°” ì„¤ì •
with st.sidebar:
    st.header("âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •")
    area = st.number_input("ì‚¬ì—… ë©´ì  (ha)", min_value=1, value=10)
    project_period = st.slider("ì‚¬ì—… ê¸°ê°„ (ë…„)", 10, 50, 30)
    
    st.subheader("ìˆ˜ì¢… ì„ íƒ")
    species_list = df_forest['name'].unique()
    selected_species = st.multiselect("ì‹ì¬ ìˆ˜ì¢… (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)", species_list, default=[species_list[0]])
    
    if not selected_species:
        st.warning("ìˆ˜ì¢…ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.")
        st.stop()
        
    st.subheader("íƒ„ì†Œ ê°€ê²© ì‹œë‚˜ë¦¬ì˜¤")
    price_scenario = st.selectbox("ê°€ê²© ì „ë§", ["Base (ê¸°ë³¸)", "High (ë‚™ê´€)", "Low (ë³´ìˆ˜)"], index=0)
    
    price_col = 'price_base'
    if price_scenario == "High (ë‚™ê´€)": price_col = 'price_high'
    elif price_scenario == "Low (ë³´ìˆ˜)": price_col = 'price_low'

# -----------------------------------------------------------
# 4. ê³„ì‚° ì—”ì§„
# -----------------------------------------------------------
years = list(range(2026, 2026 + project_period + 1))
chart_data = []
total_last_uptake = 0
species_uptakes = {} # ìˆ˜ì¢…ë³„ ìµœì¢… í¡ìˆ˜ëŸ‰ ì €ì¥

# ìˆ˜ì¢…ë³„ Në¹µ (ë‹¨ìˆœ ê· ë“± ë¶„ë°° ê°€ì •)
area_per_species = area / len(selected_species)

for sp in selected_species:
    # 1. ìˆ˜ì¢… ë°ì´í„° ì¶”ì¶œ
    sp_row = df_forest[df_forest['name'] == sp].iloc[0]
    
    # 2. 5ë…„ ë‹¨ìœ„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (0, 5, ... 50)
    x_points = list(range(0, 51, 5))
    y_points = [sp_row[f'co2_yr_{y}'] for y in x_points]
    
    # 3. ì„ í˜• ë³´ê°„ (Interpolation) -> 1ë…„ ë‹¨ìœ„ë¡œ ë³€í™˜
    f_interp = interp1d(x_points, y_points, kind='linear')
    
    # í”„ë¡œì íŠ¸ ê¸°ê°„(0~project_period)ë§Œí¼ ê³„ì‚°
    yearly_uptake_per_ha = f_interp(range(project_period + 1))
    
    # 4. ë©´ì  ì ìš©
    final_uptake = yearly_uptake_per_ha * area_per_species
    
    total_last_uptake += final_uptake[-1]
    species_uptakes[sp] = final_uptake[-1]
    
    chart_data.append(go.Scatter(x=years, y=final_uptake, name=sp, stackgroup='one'))

# -----------------------------------------------------------
# 5. ê²°ê³¼ ì‹œê°í™”
# -----------------------------------------------------------

# [ë©”ì¸ ì°¨íŠ¸]
fig = go.Figure(data=chart_data)
fig.update_layout(
    title=f"ì—°ë„ë³„ ëˆ„ì  íƒ„ì†Œ í¡ìˆ˜ëŸ‰ ({project_period}ë…„)", 
    xaxis_title="ì—°ë„", 
    yaxis_title="ëˆ„ì  í¡ìˆ˜ëŸ‰ (tCO2)",
    height=400,
    hovermode="x unified"
)
st.plotly_chart(fig, use_container_width=True)

# [ê²½ì œì„± ë¶„ì„]
# ì„ íƒí•œ ê¸°ê°„ì˜ ë§ˆì§€ë§‰ í•´(ì˜ˆ: 2056ë…„) ê°€ê²© ê°€ì ¸ì˜¤ê¸°
end_year = 2026 + project_period
if end_year > df_price['year'].max():
    # ë°ì´í„° ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ë§ˆì§€ë§‰ í•´ ê°€ê²© ì‚¬ìš©
    unit_price = df_price.iloc[-1][price_col]
else:
    unit_price = df_price[df_price['year'] == end_year][price_col].values[0]

total_value = total_last_uptake * unit_price

# [ESG ë¶„ì„]
selected_ids = df_forest[df_forest['name'].isin(selected_species)]['id']
# ID ë§¤í•‘ (CSV ê°„ ID í˜•ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ì‹œë„í•˜ê±°ë‚˜ ë¡œì§ ë³´ì™„ í•„ìš”)
# ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ co_benefits íŒŒì¼ì˜ ìˆœì„œëŒ€ë¡œ ê°€ì •í•˜ê±°ë‚˜ ë³„ë„ ë§¤í•‘ ë¡œì§ í•„ìš”
# (ì‚¬ìš©ì ë°ì´í„°ì— ë§ì¶° ê°„ì†Œí™”: í‰ê· ê°’ ê³„ì‚°)
avg_bio = df_benefit['biodiversity_index'].mean() # ì „ì²´ í‰ê·  (ë§¤í•‘ ë¡œì§ ë³µì¡ì„± íšŒí”¼)
if len(selected_species) > 1:
    avg_bio += 0.5 # í˜¼íš¨ë¦¼ ë³´ë„ˆìŠ¤
    if avg_bio > 5: avg_bio = 5.0

# [KPI ì¹´ë“œ]
c1, c2, c3 = st.columns(3)
c1.metric("ì´ ì˜ˆìƒ í¡ìˆ˜ëŸ‰", f"{total_last_uptake:,.1f} tCOâ‚‚")
c2.metric(f"ì˜ˆìƒ ê°€ì¹˜ ({price_scenario})", f"â‚©{total_value:,.0f}")
c3.metric("ESG ì§€ìˆ˜ (ìƒë¬¼ë‹¤ì–‘ì„±)", f"{avg_bio:.1f} / 5.0")

# [ìƒì„¸ ë°ì´í„°]
with st.expander("ğŸ“Š ìˆ˜ì¢…ë³„ ìƒì„¸ ê¸°ì—¬ë„ ë³´ê¸°"):
    st.write(pd.DataFrame(list(species_uptakes.items()), columns=['ìˆ˜ì¢…', 'í¡ìˆ˜ëŸ‰(tCO2)']))

`
      }
    })
  </script>
</body>
</html>
